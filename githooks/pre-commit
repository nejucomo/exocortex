#!/bin/bash
set -efuo pipefail

function main
{
  unstaged_is_dirty && fail 'Refusing to proceed with unstaged changes.'

  # Do this prior to auto-fmt-tomls to roll in both changes:
  v cargo shear --fix
  auto-fmt-tomls

  gauntlet

  v git add Cargo.lock
}

function fail
{
  echo "$*"
  exit 1
}

function unstaged_is_dirty
{
  git status --porcelain | rg '^.[^ ]'
}

function auto-fmt-tomls
{
  v taplo format
  git diff
  v git add $(fd -g '*.toml')
}

function gauntlet
{
  v nix develop --command cargo build "$@"
  v nix develop --command cargo doc "$@"
  v nix develop --command cargo clippy "$@"
  v nix develop --command cargo test "$@"
}

function v
{
  echo "=== $*"
  eval "$@"
}

main "$@"
